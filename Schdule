global class ServiceSchdulableERTUpdate implements Schedulable {

    global void execute(SchedulableContext sc) {
        updateCaseEstimate();
    }

    public static void updateCaseEstimate(){
        // List to store cases that need to be updated
        List<Case> casesToUpdate = new List<Case>();
        DateTime currentDateTime = DateTime.now().addHours(12);
        
        // Query cases where estimate_resolution_time__c is less than 12 hours remaining
        for (Case c : [SELECT Id, Likely_Restoration_Time__c, Cause__c, Diagnosis_Summary__c, Number_of_Instruments_Queried__c, Case_Owner_Name__c
                        FROM Case WHERE Likely_Restoration_Time__c < :currentDateTime AND
                        Case_Owner_Role_Static__c ='CONT_ST_RPS' AND
                        Status NOT IN ('Closed','Cancelled','Unresolved','Service Restored')]) {

            // Update estimate_resolution_time__c by adding 7 days
            c.Likely_Restoration_Time__c = c.Likely_Restoration_Time__c.addDays(7);
            casesToUpdate.add(c);
        }
        // Update the estimate_resolution_time__c field for all cases meeting the criteria
        if (!casesToUpdate.isEmpty()) {
            update casesToUpdate;
        }
        
        List<Case> casesToUpdateFields = new List<Case>();
        //String TemplateName = System.label.SC_ERT_EmailTeplateName;
        System.debug('TemplateId 0.1');
        List<EmailTemplate> emailTemplateList = [SELECT Id,Body from EmailTemplate where name ='ERTResolutionTemplateText'];
        //List<EmailTemplate> emailTemplateList = [SELECT Id,Body from EmailTemplate where name = :TemplateName];
        //List<EmailTemplate> emailTemplateList = [SELECT Id,Body from EmailTemplate where Id = '00X8D000003Kel9UAC'];
        System.debug('emailTemplateList 0.1' + emailTemplateList);
        //String emailTemplateContent = [SELECT Body from EmailTemplate where Id = '00X8D000003Kel9UAC'].Body;
        //String emailTemplateContent = [SELECT Body from EmailTemplate where name = :TemplateName].Body;
        // Loop through cases again to update fields based on condition
        for (Case c : casesToUpdate) {
            Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
            email.setTemplateId(emailTemplateList.get(0).Id);
            email.setTargetObjectId(c.Id);
            email.setWhatId(c.Id);
            email.setSaveAsActivity(false); // Check with True Also
            //emailTemplateList = emailTemplateList.replace('{{Case_Owner_Name__c}}','c.Case_Owner_Name__c');
            System.debug('emailTemplateList.get(0).Body' + emailTemplateList.get(0).Body);
            String emailTemplateContentData = emailTemplateList.get(0).Body;
            emailTemplateContentData = emailTemplateContentData.replace('{{Case_Owner_Name__c}}','c.Case_Owner_Name__c');
            System.debug('emailTemplateContentData' + emailTemplateContentData);
            email.setHtmlBody(emailTemplateContentData);
            
            // Check cause and diagnosis fields
            if(c.Cause__c =='Production - Not Part of LSEG Offering' && c.Diagnosis_Summary__c =='Content Not Available' &&
               c.Number_of_Instruments_Queried__c > 0){
                c.Status = 'Service Restored';
                c.Market_Sector__c = 'TR Pricing Services';
                c.Market_sector_Sub_Type_1__c = 'FixedIncome';
                c.Resolution_Code__c = 'New Data Added by LSEG to Existing Market';
                c.Data_Field__c = 'Pricing Services';
                c.Data_Source_Name__c = 'EJV';
                c.Data_Source_Country__c = 'Global';
                   
            } else if (c.Cause__c =='Source - Lack of Information/Source' && c.Diagnosis_Summary__c =='Content Not Available' &&
                        c.Number_of_Instruments_Queried__c > 0){
                c.Status = 'Service Restored';
                c.Market_Sector__c = 'TR Pricing Services';
                c.Market_sector_Sub_Type_1__c = 'FixedIncome';
                c.Resolution_Code__c = 'Data Not Added by LSEG';
                c.Data_Field__c = 'Pricing Services';
                c.Data_Source_Name__c = 'EJV';
                c.Data_Source_Country__c = 'Global';
                            
            } else if (c.Cause__c =='Content Explanation' && c.Diagnosis_Summary__c =='Content Explanation' && 
                       c.Number_of_Instruments_Queried__c > 0){
                c.Status = 'Service Restored';
                c.Market_Sector__c = 'TR Pricing Services';
                c.Market_sector_Sub_Type_1__c = 'FixedIncome';
                c.Resolution_Code__c = 'Data confirmed as correct';
                c.Data_Field__c = 'Pricing Services';
                c.Data_Source_Name__c = 'EJV';
                c.Data_Source_Country__c = 'Global';
                c.Content_Type__c = 'Price Challenge/variance';
                c.Resolution_Comment__c = email.getHtmlBody();
            }
            casesToUpdateFields.add(c);
        }
        if (!casesToUpdateFields.isEmpty()) {
            update casesToUpdateFields;
        }
    }
}
